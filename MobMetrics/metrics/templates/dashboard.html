{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MobMetrics</title>

  <link rel="stylesheet" href="{% static 'metrics/css/style.css' %}">

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <div class="tabs">
    <div class="tab active" onclick="switchTab('home')">Home</div>
    <div class="tab" onclick="switchTab('upload')">Upload & Process</div>
    <div class="tab" onclick="switchTab('results')">Results</div>
    <div class="tab" onclick="switchTab('manage')">Manage Files</div>
  </div>

  <div class="content" id="home">
    <h2>MobMetrics</h2>
  </div>

  <div class="content hidden" id="upload">
    <h2>File Upload</h2>
    <form method="post" action="{% url 'dashboard' %}" enctype="multipart/form-data">
      {% csrf_token %}
     
      <div class="form-container">

        <div class="form-group">
          <label for="trace-file">Trace File:</label>
          {{ upload_form.trace }}
          <span class="tooltip">?
            <span class="tooltiptext">Select the trace file</span>
          </span>
        </div>

        <div class="form-group">
          <label for="name">Name:</label>
          {{ upload_form.name }}
          <span class="tooltip">?
            <span class="tooltiptext">Name of the analysis or experiment</span>
          </span>
        </div>
        
        <div class="form-group">
          <label for="label">Label:</label>
          {{ upload_form.label }}
          <span class="tooltip">?
            <span class="tooltiptext">Label to identify the dataset type</span>
          </span>
        </div>     
      
        <div class="form-group">
          <label for="geo-coord">Geographical Coordinates:</label>
          {{ upload_form.is_geographical_coordinates }}
          <span class="tooltip">?
            <span class="tooltiptext">Select if the data contains geographical coordinates</span>
          </span>
        </div>

        <div class="parameter-group">
          <h3>Stay Point Parameters</h3>

          <div class="form-group">
            <label for="distance">Distance Threshold:</label>
            {{ upload_form.distance_threshold }}
            <span class="tooltip">?
              <span class="tooltiptext">Maximun distance between points to be classified as Stay Point</span>
            </span>
          </div>

          <div class="form-group">
            <label for="time">Time Threshold:</label>
            {{ upload_form.time_threshold }}
            <span class="tooltip">?
              <span class="tooltiptext">Minimum time to be classified as Stay Point</span>
            </span>
          </div>
        </div>

        <div class="parameter-group">
          <h3>Contact Parameters</h3>
          <div class="form-group">
            <label for="radius">Radius Threshold:</label>
            {{ upload_form.radius_threshold }}
            <span class="tooltip">?
              <span class="tooltiptext">Maximum radius to classify a contact</span>
            </span>
          </div>
        </div>

        <div class="parameter-group">
          <h3>Entropy Parameters</h3>
          <div class="form-group">
            <label for="quadrant">Quadrant Divisions:</label>
            {{ upload_form.quadrant_size }}
            <span class="tooltip">?
              <span class="tooltiptext">Number of quadrant divisions, the total quadrants will be Quradrant_Divisions^2</span>
            </span>
          </div>
        </div>
      </div>
      
      <button class="button" type="submit" name="upload">Upload</button>
    </form>

    {% if messages %}
      {% for message in messages %}
        <p style="color: orange; text-align: center;">{{ message }}</p>
      {% endfor %}
    {% endif %}
  </div>

  <div class="content hidden" id="results">
    <div class="config-section">
      <button type="button" class="button" onclick="toggleConfig()">Configuration</button>
      
      <div id="configForm" class="hidden" style="margin-top: 1rem;">
        <form method="post" action="{% url 'dashboard' %}">
          {% csrf_token %}
          
          <div class="form-container">
            <div class="form-group">
              <label for="id_PCA_n_components">PCA N Components:</label>
              {{ analytcs_form.PCA_n_components }}
              <span class="tooltip">?
                <span class="tooltiptext">Number of components for PCA</span>
              </span>
            </div>
            
            <div class="form-group">
              <label for="id_tSNE_n_components">t-SNE N Components:</label>
              {{ analytcs_form.tSNE_n_components }}
              <span class="tooltip">?
                <span class="tooltiptext">Number of components for t-SNE</span>
              </span>
            </div>
            
            <div class="form-group">
              <label for="id_tSNE_perplexity">t-SNE Perplexity:</label>
              {{ analytcs_form.tSNE_perplexity }}
              <span class="tooltip">?
                <span class="tooltiptext">The perplexity is related to the number of nearest neighbors that is used in other manifold learning algorithms. Larger datasets usually require a larger perplexity. Consider selecting a value between 5 and 50. Different values can result in significantly different results. The perplexity must be less than the number of samples.</span>
              </span>
            </div>    
          </div>
          <button class="button" type="submit" name="generate_graphs">Generate Graphs</button>
        </form>
      </div>
    </div>
    
    <h2>Results - Graphs</h2>
    
    <div class="graphs-wrapper">
      <div class="graph-container">
        <h3>PCA - MetricsModel</h3>
        <div id="pcaMetricsPlot"></div>
      </div>
  
      <div class="graph-container">
        <h3>PCA - GlobalMetricsModel</h3>
        <div id="pcaGlobalPlot"></div>
      </div>
  
      <div class="graph-container">
        <h3>t-SNE - MetricsModel</h3>
        <div id="tsneMetricsPlot"></div>
      </div>
  
      <div class="graph-container">
        <h3>t-SNE - GlobalMetricsModel</h3>
        <div id="tsneGlobalPlot"></div>
      </div>
    </div>
  </div>

  <div class="content hidden" id="manage">
    <h2>Manage Files</h2>
    {% if file_names %}
      {% for name in file_names %}
        <div class="file-item">
          <div>{{ name }}</div>
        
          <div style="display: flex; gap: 10px;">
            <form method="post" action="{% url 'dashboard' %}" class="inline-form">
              {% csrf_token %}
              <input type="hidden" name="fileName" value="{{ name }}">
              <button class="button danger" type="submit" name="delete">Delete</button>
            </form>
        
            <form method="post" action="{% url 'dashboard' %}" class="inline-form">
              {% csrf_token %}
              <input type="hidden" name="fileName" value="{{ name }}">
              <button class="button success" type="submit" name="download">Download</button>
            </form>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p style="text-align: center; color: #888;">No files found.</p>
    {% endif %}
  </div>

  <script>
    function toggleConfig() {
      const configDiv = document.getElementById('configForm');
      configDiv.classList.toggle('hidden');
    }

    function switchTab(id) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.content').forEach(c => c.classList.add('hidden'));
      document.querySelector(`.tab[onclick="switchTab('${id}')"]`).classList.add('active');
      document.getElementById(id).classList.remove('hidden');
      localStorage.setItem('lastTab', id);
    }

    document.addEventListener("DOMContentLoaded", function () {
      const lastTab = localStorage.getItem('lastTab') || 'home';
      switchTab(lastTab);

      document.querySelectorAll("form").forEach(form => {
        form.addEventListener("submit", () => {
          const visibleTab = document.querySelector(".content:not(.hidden)");
          if (visibleTab && visibleTab.id) {
            localStorage.setItem("lastTab", visibleTab.id);
          }
        });
      });
    });

    const pcaMetrics = JSON.parse('{{ pca_metrics|escapejs }}');
    const pcaGlobal = JSON.parse('{{ pca_global|escapejs }}');
    const tsneMetrics = JSON.parse('{{ tsne_metrics|escapejs }}');
    const tsneGlobal = JSON.parse('{{ tsne_global|escapejs }}');

    function prepareDataByLabel(data, xKey, yKey) {
      const grouped = {};
      data.forEach(item => {
        const label = item.label || 'undefined';
        if (!grouped[label]) grouped[label] = { x: [], y: [], name: label };
        grouped[label].x.push(item[xKey]);
        grouped[label].y.push(item[yKey]);
      });
      return Object.values(grouped).map(group => ({
        x: group.x,
        y: group.y,
        mode: 'markers',
        type: 'scatter',
        name: group.name
      }));
    }

    Plotly.newPlot('pcaMetricsPlot', prepareDataByLabel(pcaMetrics, 'PC1', 'PC2'), {
      title: 'PCA - MetricsModel',
      xaxis: { title: 'PC1' },
      yaxis: { title: 'PC2' }
    });

    Plotly.newPlot('pcaGlobalPlot', prepareDataByLabel(pcaGlobal, 'PC1', 'PC2'), {
      title: 'PCA - GlobalMetricsModel',
      xaxis: { title: 'PC1' },
      yaxis: { title: 'PC2' }
    });

    Plotly.newPlot('tsneMetricsPlot', prepareDataByLabel(tsneMetrics, 'TSNE1', 'TSNE2'), {
      title: 't-SNE - MetricsModel',
      xaxis: { title: 'TSNE1' },
      yaxis: { title: 'TSNE2' }
    });

    Plotly.newPlot('tsneGlobalPlot', prepareDataByLabel(tsneGlobal, 'TSNE1', 'TSNE2'), {
      title: 't-SNE - GlobalMetricsModel',
      xaxis: { title: 'TSNE1' },
      yaxis: { title: 'TSNE2' }
    });
  </script>
</body>
</html>
