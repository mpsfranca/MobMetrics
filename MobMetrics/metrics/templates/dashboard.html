{% load static %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MobMetrics</title>

  <link rel="stylesheet" href="{% static 'metrics/css/style.css' %}">

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

 
</head>
<body>
  <div class="tabs">
    <div class="tab active" onclick="switchTab('home')">Home</div>
    <div class="tab" onclick="switchTab('upload')">Upload & Processar</div>
    <div class="tab" onclick="switchTab('resultados')">Resultados</div>
    <div class="tab" onclick="switchTab('gerenciar')">Gerenciar Arquivos</div>
  </div>

  <div class="content" id="home">
    <h2>MobMetrics</h2>
  </div>

  <div class="content hidden" id="upload">
    <h2>Upload de Arquivo</h2>
    <form method="post" action="{% url 'dashboard' %}" enctype="multipart/form-data">
      {% csrf_token %}
     
      <div class="form-container">

        <!-- Trace File-->
        <div class="form-group">
          <label for="trace-file">Trace file:</label>
          {{ upload_form.trace }}
          <span class="tooltip">?
            <span class="tooltiptext">Selecione o arquivo de rastreamento</span>
          </span>
        </div>

        <!-- File Name -->
        <div class="form-group">
          <label for="name">Name:</label>
          {{ upload_form.name }}
          <span class="tooltip">?
            <span class="tooltiptext">Nome da análise ou experimento</span>
          </span>
        </div>
        
        <!-- File Label -->
        <div class="form-group">
          <label for="label">Label:</label>
          {{ upload_form.label }}
          <span class="tooltip">?
            <span class="tooltiptext">Rótulo para identificar o conjunto</span>
          </span>
        </div>     
      
        <!-- Geohraphical Coodinates -->
        <div class="form-group">
          <label for="geo-coord">Geographical Coordinates:</label>
          {{ upload_form.is_geographical_coordinates }}
          <span class="tooltip">?
            <span class="tooltiptext">Habilite se os dados forem coordenadas geográficas</span>
          </span>
        </div>

        <div class="parameter-group">
          <h3>Stay Point Parameters</h3>

          <!-- Distance Threshold -->
          <div class="form-group">
            <label for="distance">Distance Threshold:</label>
            {{ upload_form.distance_threshold }}
            <span class="tooltip">?
              <span class="tooltiptext">Distância mínima entre pontos (em metros)</span>
            </span>
          </div>

          <!-- Time Threshold -->
          <div class="form-group">
            <label for="time">Time Threshold:</label>
            {{ upload_form.time_threshold }}
            <span class="tooltip">?
              <span class="tooltiptext">Tempo mínimo entre eventos (em segundos)</span>
            </span>
          </div>
        </div>
        <div class="parameter-group">
          <h3>Contact Parameters</h3>
          
          <!-- Radius Threshold -->
          <div class="form-group">
            <label for="radius">Radius Threshold:</label>
            {{ upload_form.radius_threshold }}
            <span class="tooltip">?
              <span class="tooltiptext">Raio máximo considerado para agrupamento</span>
            </span>
          </div>
        </div>
        <div class="parameter-group">
          <h3>Entropy Parameters</h3>
        
          <!-- Quadrants Divisions -->
          <div class="form-group">
            <label for="quadrant">Quadrant Divisions:</label>
            {{ upload_form.quadrant_size }}
            <span class="tooltip">?
              <span class="tooltiptext">Número de divisões do quadrante</span>
            </span>
          </div>
        </div>
      

      </div>
      
      <button class="button" type="submit" name="upload">Upload</button>
    </form>

    {% if messages %}
      {% for message in messages %}
        <p style="color: orange; text-align: center;">{{ message }}</p>
      {% endfor %}
    {% endif %}
  </div>

  <div class="content hidden" id="resultados">
    <div class="config-section">
      <button type="button" class="button" onclick="toggleConfig()">Configuração</button>
      
      <div id="configForm" class="hidden" style="margin-top: 1rem;">
        <form method="post" action="{% url 'dashboard' %}">
          {% csrf_token %}
          
          <div class="form-container">
            <div class="form-group">
              <label for="id_PCA_n_components">PCA N Components:</label>
              {{ analytcs_form.PCA_n_components }}
              <span class="tooltip">?
                <span class="tooltiptext">Habilite se os dados forem coordenadas geográficas</span>
              </span>
            </div>
            
            <div class="form-group">
              <label for="id_tSNE_n_components">t-SNE N Components:</label>
              {{ analytcs_form.tSNE_n_components }}
              <span class="tooltip">?
                <span class="tooltiptext">Habilite se os dados forem coordenadas geográficas</span>
              </span>
            </div>
            
            <div class="form-group">
              <label for="id_tSNE_perplexity">t-SNE Perplexity:</label>
              {{ analytcs_form.tSNE_perplexity }}
              <span class="tooltip">?
                <span class="tooltiptext">Habilite se os dados forem coordenadas geográficas</span>
              </span>
            </div>    
          </div>
          <button class="button" type="submit" name="generate_graphs">Gerar Gráficos</button>
        </form>
      </div>
    </div>
    
      <h2>Resultados - Gráficos</h2>
    
      <div class="graphs-wrapper">
        <div class="graph-container">
          <h3>PCA - MetricsModel</h3>
          <div id="pcaMetricsPlot"></div>
        </div>
    
        <div class="graph-container">
          <h3>PCA - GlobalMetricsModel</h3>
          <div id="pcaGlobalPlot"></div>
        </div>
    
        <div class="graph-container">
          <h3>t-SNE - MetricsModel</h3>
          <div id="tsneMetricsPlot"></div>
        </div>
    
        <div class="graph-container">
          <h3>t-SNE - GlobalMetricsModel</h3>
          <div id="tsneGlobalPlot"></div>
        </div>

    </div>
    
  </div>

  <div class="content hidden" id="gerenciar">
    <h2>Gerenciar Arquivos</h2>
    {% if file_names %}
      {% for name in file_names %}
        <div class="file-item">
          <span>{{ name }}</span>
        
          <div style="display: flex; gap: 10px;">
            <form method="post" action="{% url 'dashboard' %}" class="inline-form">
              {% csrf_token %}
              <input type="hidden" name="fileName" value="{{ name }}">
              <button class="button danger" type="submit" name="delete">Excluir</button>
            </form>
        
            <form method="post" action="{% url 'dashboard' %}" class="inline-form">
              {% csrf_token %}
              <input type="hidden" name="fileName" value="{{ name }}">
              <button class="button success" type="submit" name="download">Download</button>
            </form>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <p style="text-align: center; color: #888;">Nenhum arquivo encontrado.</p>
    {% endif %}
  </div>

  
  <script>
    function toggleConfig() {
      const configDiv = document.getElementById('configForm');
      configDiv.classList.toggle('hidden');
    }
  
    function switchTab(id) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.content').forEach(c => c.classList.add('hidden'));
      document.querySelector(`.tab[onclick="switchTab('${id}')"]`).classList.add('active');
      document.getElementById(id).classList.remove('hidden');
  
      // Salvar a aba no localStorage
      localStorage.setItem('lastTab', id);
    }
  
    document.addEventListener("DOMContentLoaded", function () {
      // Restaurar a aba ativa
      const lastTab = localStorage.getItem('lastTab') || 'home';
      switchTab(lastTab);
  
      // Antes de qualquer envio de formulário, salvar a aba visível
      document.querySelectorAll("form").forEach(form => {
        form.addEventListener("submit", () => {
          const visibleTab = document.querySelector(".content:not(.hidden)");
          if (visibleTab && visibleTab.id) {
            localStorage.setItem("lastTab", visibleTab.id);
          }
        });
      });
    });
  
    // Dados dos gráficos vindos do backend (Django)
    const pcaMetrics = JSON.parse('{{ pca_metrics|escapejs }}');
    const pcaGlobal = JSON.parse('{{ pca_global|escapejs }}');
    const tsneMetrics = JSON.parse('{{ tsne_metrics|escapejs }}');
    const tsneGlobal = JSON.parse('{{ tsne_global|escapejs }}');
  
    function prepareDataByLabel(data, xKey, yKey) {
      const grouped = {};
      data.forEach(item => {
        const label = item.label || 'undefined';
        if (!grouped[label]) grouped[label] = { x: [], y: [], name: label };
        grouped[label].x.push(item[xKey]);
        grouped[label].y.push(item[yKey]);
      });
      return Object.values(grouped).map(group => ({
        x: group.x,
        y: group.y,
        mode: 'markers',
        type: 'scatter',
        name: group.name
      }));
    }
  
    Plotly.newPlot('pcaMetricsPlot', prepareDataByLabel(pcaMetrics, 'PC1', 'PC2'), {
      title: 'PCA - MetricsModel',
      xaxis: { title: 'PC1' },
      yaxis: { title: 'PC2' }
    });
  
    Plotly.newPlot('pcaGlobalPlot', prepareDataByLabel(pcaGlobal, 'PC1', 'PC2'), {
      title: 'PCA - GlobalMetricsModel',
      xaxis: { title: 'PC1' },
      yaxis: { title: 'PC2' }
    });
  
    Plotly.newPlot('tsneMetricsPlot', prepareDataByLabel(tsneMetrics, 'TSNE1', 'TSNE2'), {
      title: 't-SNE - MetricsModel',
      xaxis: { title: 'TSNE1' },
      yaxis: { title: 'TSNE2' }
    });
  
    Plotly.newPlot('tsneGlobalPlot', prepareDataByLabel(tsneGlobal, 'TSNE1', 'TSNE2'), {
      title: 't-SNE - GlobalMetricsModel',
      xaxis: { title: 'TSNE1' },
      yaxis: { title: 'TSNE2' }
    });
  </script>
  
</body>
</html>
