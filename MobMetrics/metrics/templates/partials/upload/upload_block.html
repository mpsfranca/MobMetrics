<div class="content d-none" id="upload">
    <div class="container py-4">
        {% include 'partials/upload/upload_header.html' %}


        <form method="post" action="{% url 'dashboard' %}" enctype="multipart/form-data" class="needs-validation"
            novalidate>
            {% csrf_token %}


            {% include 'partials/upload/upload_data_upload.html' %}


            <!-- Accordion: Parameters -->
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <div class="text-muted small">Step 2</div>
                    <h3 class="h5 fw-bold mb-0" style="color:#1e293b;">Parameters</h3>
                    <div class="text-muted small">Open only what you need.</div>
                </div>


                <div class="card-body p-0">
                    <div class="accordion accordion-flush" id="uploadParamsAccordion">


                        <!-- Stay Points -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="spHead">
                                <button class="accordion-button collapsed fw-semibold" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#spCollapse" aria-expanded="false"
                                    aria-controls="spCollapse">
                                    <i class="fas fa-map-marker-alt text-info me-2"></i>
                                    Stay Points (Preprocessing)
                                    <span class="badge text-bg-info ms-2">SP</span>
                                </button>
                            </h2>
                            <div id="spCollapse" class="accordion-collapse collapse" aria-labelledby="spHead"
                                data-bs-parent="#uploadParamsAccordion">
                                <div class="accordion-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">
                                                Distance threshold (Dths)
                                                <a href="#" class="ms-1 text-muted" role="button"
                                                    data-bs-toggle="tooltip" data-bs-placement="top"
                                                    title="Max distance between points for a Stay Point cluster (meters).">
                                                    <i class="fas fa-circle-info"></i>
                                                </a>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">m</span>
                                                {{ upload_form.distance_threshold }}
                                            </div>
                                        </div>


                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">
                                                Time threshold (Tths)
                                                <a href="#" class="ms-1 text-muted" role="button"
                                                    data-bs-toggle="tooltip" data-bs-placement="top"
                                                    title="Min dwell time to be classified as Stay Point (seconds).">
                                                    <i class="fas fa-circle-info"></i>
                                                </a>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">s</span>
                                                {{ upload_form.time_threshold }}
                                            </div>
                                        </div>
                                    </div>


                                    <div class="alert alert-light border mt-3 mb-0 small text-muted">
                                        Dths + Tths affect segmentation and metrics that depend on stay points.
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Contacts -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="cttHead">
                                <button class="accordion-button collapsed fw-semibold" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#cttCollapse" aria-expanded="false"
                                    aria-controls="cttCollapse">
                                    <i class="fas fa-users text-warning me-2"></i>
                                    Contacts (Social)
                                    <span class="badge text-bg-warning ms-2">Ctt</span>
                                </button>
                            </h2>
                            <div id="cttCollapse" class="accordion-collapse collapse" aria-labelledby="cttHead"
                                data-bs-parent="#uploadParamsAccordion">
                                <div class="accordion-body">


                                    <div class="form-check mb-3">
                                        {{ upload_form.skip_contact_detection }}
                                        <label class="form-check-label fw-semibold">
                                            Skip contact detection
                                            <a href="#" class="ms-1 text-muted" role="button" data-bs-toggle="tooltip"
                                                data-bs-placement="top"
                                                title="Skip the social contact detection step for faster runs.">
                                                <i class="fas fa-circle-info"></i>
                                            </a>
                                        </label>
                                    </div>


                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">
                                                Radius threshold (CRths)
                                                <a href="#" class="ms-1 text-muted" role="button"
                                                    data-bs-toggle="tooltip" data-bs-placement="top"
                                                    title="Distance threshold to count a contact at the same timestamp (meters).">
                                                    <i class="fas fa-circle-info"></i>
                                                </a>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">m</span>
                                                {{ upload_form.radius_threshold }}
                                            </div>
                                        </div>


                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">
                                                Contact time threshold
                                                <a href="#" class="ms-1 text-muted" role="button"
                                                    data-bs-toggle="tooltip" data-bs-placement="top"
                                                    title="Max gap between contacts to merge into a continuous event (seconds).">
                                                    <i class="fas fa-circle-info"></i>
                                                </a>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">s</span>
                                                {{ upload_form.contact_time_threshold }}
                                            </div>
                                        </div>
                                    </div>


                                    <div class="alert alert-light border mt-3 mb-0 small text-muted">
                                        Contacts are computed by timestamp and grouped into events using the time
                                        threshold.
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Entropy -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="entropyHead">
                                <button class="accordion-button collapsed fw-semibold" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#entropyCollapse" aria-expanded="false"
                                    aria-controls="entropyCollapse">
                                    <i class="fas fa-border-all text-primary me-2"></i>
                                    Quadrants / Entropy (Spatial)
                                    <span class="badge text-bg-primary ms-2">QEtp</span>
                                </button>
                            </h2>
                            <div id="entropyCollapse" class="accordion-collapse collapse" aria-labelledby="entropyHead"
                                data-bs-parent="#uploadParamsAccordion">
                                <div class="accordion-body">
                                    <label class="form-label fw-semibold">
                                        Quadrant divisions (Qdiv)
                                        <a href="#" class="ms-1 text-muted" role="button" data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Divides each axis into Q parts; total quadrants = Q^2 (2D).">
                                            <i class="fas fa-circle-info"></i>
                                        </a>
                                    </label>


                                    <div class="input-group">
                                        <span class="input-group-text">Q</span>
                                        {{ upload_form.quadrant_parts }}
                                    </div>


                                    <div class="form-text">Used by Spatial Cover and Quadrant Entropy.</div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
            </div>


            <!-- Run -->
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-body p-4">
                    <div class="d-flex align-items-start justify-content-between flex-wrap gap-3">
                        <div>
                            <h3 class="h5 fw-bold mb-1" style="color:#1e293b;">Run</h3>
                            <div class="text-muted">
                                Upload and execute the pipeline. Results will appear in the Results tab.
                            </div>
                        </div>


                        <div class="d-grid gap-2" style="min-width: 240px;">
                            <button class="btn btn-primary btn-lg" type="submit" name="upload">
                                <i class="fas fa-play me-2"></i>Upload & Process
                            </button>
                            <button class="btn btn-outline-secondary" type="button" onclick="switchTab('results')">
                                <i class="fas fa-chart-line me-2"></i>Go to Results
                            </button>
                        </div>
                    </div>


                    {% if messages %}
                    <div class="mt-3">
                        {% for message in messages %}
                        <div class="alert alert-warning mb-2">{{ message }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>


        </form>
    </div>
</div>